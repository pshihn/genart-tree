<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="genart-tree">
  <template>
    <style>
      :host {
        display: block;
      }

      canvas {
        display: block;
        margin: 0 auto;
      }
    </style>
    <canvas id="c"></canvas>
  </template>
  <script>
    class GenartTree extends Polymer.Element {
      static get is() { return 'genart-tree'; }

      connectedCallback() {
        super.connectedCallback();
        this.refresh();
      }

      refresh() {
        if (this.offsetWidth && window.innerHeight) {
          let w = this.offsetWidth;
          let h = Math.max(300, window.innerHeight - 160);
          this.width = Math.min(w, h);
          this.height = this.width;
          this.background = '#fff'; //'#000226';
          this.color = '#000'; //'#b21d59';
          this.draw();
        } else {
          setTimeout(() => {
            this.refresh();
          }, 100);
        }
      }

      draw() {
        this.style.background = this.background;

        let width = this.width;
        let height = this.height;
        const c = this.$.c;
        c.width = this.width;
        c.height = this.height;
        const ctx = c.getContext('2d');

        ctx.clearRect(0, 0, width, height);
        ctx.save();
        ctx.fillStyle = this.background;
        ctx.fillRect(0, 0, width, height);
        ctx.restore();

        ctx.translate(width / 2, height / 2);
        ctx.rotate(Math.random() * Math.PI * 2);
        this.rootBranches(ctx, width / 8, 8, Math.PI / 4);
      }

      rootBranches(ctx, length, value, angle) {
        ctx.strokeStyle = this.color;
        let incr = (Math.PI * 2) / value;
        for (let i = 0; i < value; i++) {
          ctx.save();
          let rotation = (incr * i) - Math.PI - (Math.random() * (Math.PI / 3));
          ctx.rotate(rotation);
          this.branch(ctx, length, angle);
          ctx.restore();
        }
      }

      branch(ctx, length, angle) {
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, -length);
        ctx.stroke();
        ctx.translate(0, -length);
        length = length * 0.7;
        angle = angle - (Math.PI / 6) + (Math.random() * (Math.PI / 3.6));
        if (length > 2) {
          ctx.save();
          ctx.rotate(angle);
          this.branch(ctx, length, angle);
          ctx.restore();
          ctx.save();
          ctx.rotate(-angle);
          this.branch(ctx, length, angle);
          ctx.restore();
        }
      }
    }
    window.customElements.define(GenartTree.is, GenartTree);
  </script>
</dom-module>